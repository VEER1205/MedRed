<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MedRed - User Information</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

      :root {
        --background: hsl(0, 0%, 7%);
        --foreground: hsl(0, 0%, 98%);
        --primary: hsl(0, 72%, 58%);
        --primary-dark: hsl(0, 72%, 48%);
        --accent: hsl(0, 85%, 65%);
        --muted: hsl(0, 0%, 65%);
        --border: hsl(0, 0%, 18%);
        --card-bg: rgba(26, 26, 26, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        background-color: var(--background);
        color: var(--foreground);
        overflow-x: hidden;
        min-height: 100vh;
        position: relative;
      }

      #canvas {
        pointer-events: none;
        position: fixed;
        inset: 0;
        z-index: 0;
      }

      .blob {
        position: fixed;
        border-radius: 50%;
        filter: blur(120px);
        animation: float 6s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
      }

      .blob-1 {
        top: 20%;
        left: 10%;
        width: 20rem;
        height: 20rem;
        background: rgba(234, 67, 53, 0.15);
      }

      .blob-2 {
        bottom: 20%;
        right: 10%;
        width: 24rem;
        height: 24rem;
        background: rgba(255, 82, 82, 0.15);
        animation-delay: 2s;
      }

      @keyframes float {
        0%, 100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-40px) scale(1.05);
        }
      }

      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: var(--card-bg);
        backdrop-filter: blur(24px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1rem 2rem;
      }

      .navbar-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .logo-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        background: rgba(234, 67, 53, 0.1);
      }

      .gradient-text {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .user-info-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 14px;
      }

      .user-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .user-name {
        font-weight: 600;
        color: var(--foreground);
        font-size: 14px;
      }

      .user-email {
        color: var(--muted);
        font-size: 12px;
      }

      .logout-btn {
        padding: 10px 20px;
        background: transparent;
        color: var(--primary);
        border: 1px solid var(--primary);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 100px 20px 50px;
        position: relative;
        z-index: 1;
      }

      .main-card {
        background: var(--card-bg);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 40px;
        position: relative;
        overflow: hidden;
      }

      .card-glow {
        position: absolute;
        right: -4rem;
        bottom: -4rem;
        width: 12rem;
        height: 12rem;
        border-radius: 50%;
        background: rgba(234, 67, 53, 0.15);
        filter: blur(3rem);
        pointer-events: none;
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
      }

      .page-subtitle {
        color: var(--muted);
        font-size: 0.95rem;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
      }

      .profile-pic-section {
        display: flex;
        align-items: center;
        gap: 24px;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        z-index: 1;
      }

      .profile-pic {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        color: white;
        font-weight: bold;
        box-shadow: 0 8px 24px rgba(234, 67, 53, 0.3);
      }

      .profile-pic-info {
        flex: 1;
      }

      .profile-pic-info h3 {
        font-size: 16px;
        color: var(--foreground);
        margin-bottom: 6px;
        font-weight: 600;
      }

      .profile-pic-info p {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 12px;
      }

      .upload-btn {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--foreground);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upload-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--primary);
      }

      .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--foreground);
        margin-top: 30px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        z-index: 1;
      }

      .section-title::before {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 60px;
        height: 2px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        display: block;
        color: #e0e0e0;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .form-control {
        width: 100%;
        padding: 12px 16px;
        background: rgba(30, 30, 30, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        color: #ffffff;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(30, 30, 30, 0.95);
        box-shadow: 0 0 0 3px rgba(234, 67, 53, 0.1);
      }

      .form-control::placeholder {
        color: #888888;
      }

      .form-control.error {
        border-color: var(--primary);
        background: rgba(234, 67, 53, 0.05);
      }

      .form-control.success {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.05);
      }

      select.form-control {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888888' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 40px;
      }

      textarea.form-control {
        min-height: 100px;
        resize: vertical;
      }

      .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .radio-option input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
      }

      .radio-option label {
        margin-bottom: 0;
        font-weight: 500;
        cursor: pointer;
        color: var(--foreground);
      }

      .error-message {
        color: var(--primary);
        font-size: 0.8rem;
        margin-top: 6px;
        display: none;
        animation: slideDown 0.3s ease;
      }

      .error-message.show {
        display: block;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn-group {
        display: flex;
        gap: 16px;
        margin-top: 40px;
        justify-content: flex-end;
        position: relative;
        z-index: 1;
      }

      .btn {
        padding: 14px 32px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white;
        box-shadow: 0 0 20px hsla(0, 72%, 58%, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-2px);
        box-shadow: 0 0 30px hsla(0, 72%, 58%, 0.5);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-primary.loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
      }

      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--foreground);
      }

      .success-message {
        position: fixed;
        top: 90px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(234, 67, 53, 0.4);
        display: flex;
        align-items: center;
        gap: 12px;
        opacity: 0;
        transform: translateX(400px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 2000;
        font-weight: 500;
      }

      .success-message.show {
        opacity: 1;
        transform: translateX(0);
      }

      .success-message i {
        font-size: 18px;
      }

      @media (max-width: 768px) {
        .navbar {
          padding: 1rem;
        }

        .navbar-content {
          flex-direction: column;
          gap: 15px;
        }

        .user-info-header {
          width: 100%;
          justify-content: center;
        }

        .container {
          padding: 140px 15px 30px;
        }

        .main-card {
          padding: 30px 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .btn-group {
          flex-direction: column-reverse;
        }

        .btn {
          width: 100%;
        }

        .profile-pic-section {
          flex-direction: column;
          text-align: center;
        }

        .page-title {
          font-size: 1.75rem;
        }

        .blob {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <nav class="navbar">
      <div class="navbar-content">
        <a class="logo" href="/">
          <div class="logo-icon">
            <i class="fas fa-capsules" style="color: #ef4444; font-size: 20px;"></i>
          </div>
          <span class="gradient-text">MedRed</span>
        </a>

        <div style="display: flex; align-items: center; gap: 20px;">
          <div class="user-info-header" id="userInfoHeader" style="display: none;">
            <div class="user-avatar" id="navAvatar">JD</div>
            <div class="user-details">
              <div class="user-name" id="navUserName">John Doe</div>
              <div class="user-email" id="navUserEmail">john@example.com</div>
            </div>
          </div>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="main-card">
        <div class="card-glow"></div>
        
        <h1 class="page-title">User Information</h1>
        <p class="page-subtitle">
          Complete your profile to get personalized medicine reminders
        </p>

        <div class="profile-pic-section">
          <div class="profile-pic" id="profilePic">JD</div>
          <div class="profile-pic-info">
            <h3>Profile Picture</h3>
            <p>Upload a photo to personalize your account</p>
            <button
              class="upload-btn"
              onclick="document.getElementById('fileInput').click()"
            >
              <i class="fas fa-upload"></i> Upload Photo
            </button>
            <input
              type="file"
              id="fileInput"
              accept="image/*"
              style="display: none"
              onchange="handleFileUpload(event)"
            />
          </div>
        </div>

        <form id="userInfoForm">
          <div class="section-title">Personal Information</div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="fname">First Name *</label>
              <input
                type="text"
                class="form-control"
                id="fname"
                name="fname"
                placeholder="John"
                maxlength="50"
                required
                readonly
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="lname">Last Name *</label>
              <input
                type="text"
                class="form-control"
                id="lname"
                name="lname"
                placeholder="Doe"
                maxlength="50"
                required
                readonly
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="email">Email Address *</label>
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                placeholder="john@example.com"
                maxlength="50"
                required
                readonly
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="mobileNumber">Mobile Number *</label>
              <input
                type="tel"
                class="form-control"
                id="mobileNumber"
                name="mobileNumber"
                placeholder="9876543210"
                maxlength="10"
                required
              />
              <div class="error-message" id="mobileNumberError"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Gender *</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input
                    type="radio"
                    id="male"
                    name="gender"
                    value="male"
                    required
                  />
                  <label for="male">Male</label>
                </div>
                <div class="radio-option">
                  <input
                    type="radio"
                    id="female"
                    name="gender"
                    value="female"
                  />
                  <label for="female">Female</label>
                </div>
              </div>
              <div class="error-message" id="genderError"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="bloodGroup">Blood Group *</label>
              <select class="form-control" id="bloodGroup" name="bloodGroup" required>
                <option value="">Select Blood Group</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
              <div class="error-message" id="bloodGroupError"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="birthDate">Date of Birth *</label>
              <input
                type="date"
                class="form-control"
                id="birthDate"
                name="birthDate"
                required
                max=""
              />
              <div class="error-message" id="birthDateError"></div>
            </div>
          </div>

          <div class="section-title">Address Information</div>

          <div class="form-group full-width">
            <label class="form-label" for="streetAddress">Street Address *</label>
            <input
              type="text"
              class="form-control"
              id="streetAddress"
              name="streetAddress"
              placeholder="123 Main Street"
              maxlength="100"
              required
            />
            <div class="error-message" id="streetAddressError"></div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="city">City *</label>
              <input
                type="text"
                class="form-control"
                id="city"
                name="city"
                placeholder="Mumbai"
                maxlength="100"
                required
              />
              <div class="error-message" id="cityError"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="state">State *</label>
              <input
                type="text"
                class="form-control"
                id="state"
                name="state"
                placeholder="Maharashtra"
                maxlength="100"
                required
              />
              <div class="error-message" id="stateError"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="pinCode">PIN Code *</label>
              <input
                type="text"
                class="form-control"
                id="pinCode"
                name="pinCode"
                placeholder="400001"
                maxlength="6"
                required
              />
              <div class="error-message" id="pinCodeError"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="country">Country *</label>
              <select class="form-control" id="country" name="country" required>
                <option value="">Select Country</option>
                <option value="India" selected>India</option>
                <option value="United States">United States</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="Canada">Canada</option>
                <option value="Australia">Australia</option>
              </select>
              <div class="error-message" id="countryError"></div>
            </div>
          </div>

          <div class="section-title">Medical Information</div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="emergencyContactNumber">Emergency Contact Number *</label>
              <input
                type="tel"
                class="form-control"
                id="emergencyContactNumber"
                name="emergencyContactNumber"
                placeholder="9876543210"
                maxlength="10"
                required
              />
              <div class="error-message" id="emergencyContactNumberError"></div>
            </div>
          </div>

          <div class="form-group full-width">
            <label class="form-label" for="allergies">Allergies</label>
            <textarea
              class="form-control"
              id="allergies"
              name="allergies"
              placeholder="List any known allergies to medications or other substances..."
              maxlength="200"
            ></textarea>
          </div>

          <div class="form-group full-width">
            <label class="form-label" for="medicalConditions">Medical Conditions</label>
            <textarea
              class="form-control"
              id="medicalConditions"
              name="medicalConditions"
              placeholder="List any chronic conditions or ongoing medical treatments..."
              maxlength="200"
            ></textarea>
          </div>

          <div class="btn-group">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="resetForm()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              Save Information
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Initialize user data
      let userData = {
        fname: '',
        lname: '',
        email: ''
      };

      // Validation Functions
      function validateMobileNumber(mobile) {
        return /^\d{10}$/.test(mobile);
      }

      function validatePinCode(pin) {
        return /^\d{6}$/.test(pin);
      }

      function validateBirthDate(date) {
        if (!date) return false;
        const birthDate = new Date(date);
        const today = new Date();
        return birthDate < today;
      }

      function validateName(name) {
        const trimmed = name.trim();
        return trimmed.length >= 2 && /^[a-zA-Z\s'-]+$/.test(trimmed);
      }

      function showError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        if (input && error) {
          input.classList.add('error');
          input.classList.remove('success');
          error.textContent = message;
          error.classList.add('show');
        }
      }

      function clearError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        if (input && error) {
          input.classList.remove('error');
          input.classList.add('success');
          error.classList.remove('show');
        }
      }

      // Load user data from backend
      async function loadUserData() {
        try {
          const response = await fetch('/api/me', {
            method: 'GET',
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Failed to load user data');
          }
          
          const data = await response.json();
          console.log('User Data from Backend:', data);

          userData = { fname: data.fname, lname: data.lname, email: data.email };
          
          // Populate form fields
          document.getElementById('fname').value = data.fname || '';
          document.getElementById('lname').value = data.lname || '';
          document.getElementById('email').value = data.email || '';
          
          // Update header and profile pic
          updateUserHeader();
          updateProfilePic();
        } catch (error) {
          console.error('Error loading user data:', error);
          showSuccessMessage('Error loading user data. Please refresh the page.');
        }
      }

      // Update user header
      function updateUserHeader() {
        if (userData.fname && userData.lname && userData.email) {
          const fullName = `${userData.fname} ${userData.lname}`;
          const initials = `${userData.fname.charAt(0)}${userData.lname.charAt(0)}`.toUpperCase();
          
          document.getElementById('navAvatar').textContent = initials;
          document.getElementById('navUserName').textContent = fullName;
          document.getElementById('navUserEmail').textContent = userData.email;
          document.getElementById('userInfoHeader').style.display = 'flex';
        }
      }

      // Update profile pic
      function updateProfilePic() {
        if (userData.fname && userData.lname) {
          const initials = `${userData.fname.charAt(0)}${userData.lname.charAt(0)}`.toUpperCase();
          document.getElementById('profilePic').textContent = initials;
        }
      }

      // Handle file upload
      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const profilePic = document.getElementById('profilePic');
            profilePic.style.backgroundImage = `url(${e.target.result})`;
            profilePic.style.backgroundSize = 'cover';
            profilePic.style.backgroundPosition = 'center';
            profilePic.textContent = '';
          };
          reader.readAsDataURL(file);
        }
      }

      // Show success message
      function showSuccessMessage(message) {
        const existingMessage = document.querySelector('.success-message');
        if (existingMessage) {
          existingMessage.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = 'success-message';
        messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        document.body.appendChild(messageDiv);

        setTimeout(() => messageDiv.classList.add('show'), 100);
        setTimeout(() => {
          messageDiv.classList.remove('show');
          setTimeout(() => messageDiv.remove(), 400);
        }, 3000);
      }

      // Validate form
      function validateForm(formData) {
        let isValid = true;

        // Mobile number validation
        if (!formData.mobileNumber || !validateMobileNumber(formData.mobileNumber)) {
          showError('mobileNumber', 'mobileNumberError', 'Please enter a valid 10-digit mobile number');
          isValid = false;
        } else {
          clearError('mobileNumber', 'mobileNumberError');
        }

        // Emergency contact validation
        if (!formData.emergencyContactNumber) {
          showError('emergencyContactNumber', 'emergencyContactNumberError', 'Emergency contact number is required');
          isValid = false;
        } else if (!validateMobileNumber(formData.emergencyContactNumber)) {
          showError('emergencyContactNumber', 'emergencyContactNumberError', 'Please enter a valid 10-digit emergency contact number');
          isValid = false;
        } else {
          clearError('emergencyContactNumber', 'emergencyContactNumberError');
        }

        // Gender validation
        if (!formData.gender) {
          showError('male', 'genderError', 'Please select a gender');
          isValid = false;
        } else {
          clearError('male', 'genderError');
        }

        // Blood group validation
        if (!formData.bloodGroup) {
          showError('bloodGroup', 'bloodGroupError', 'Blood group is required');
          isValid = false;
        } else {
          clearError('bloodGroup', 'bloodGroupError');
        }

        // Birth date validation
        if (!formData.birthDate) {
          showError('birthDate', 'birthDateError', 'Birth date is required');
          isValid = false;
        } else if (!validateBirthDate(formData.birthDate)) {
          showError('birthDate', 'birthDateError', 'Please enter a valid birth date in the past');
          isValid = false;
        } else {
          clearError('birthDate', 'birthDateError');
        }

        // Street address validation
        if (!formData.streetAddress || formData.streetAddress.trim().length < 5) {
          showError('streetAddress', 'streetAddressError', 'Please enter a valid street address (minimum 5 characters)');
          isValid = false;
        } else {
          clearError('streetAddress', 'streetAddressError');
        }

        // City validation
        if (!formData.city || formData.city.trim().length < 2) {
          showError('city', 'cityError', 'Please enter a valid city name');
          isValid = false;
        } else if (!validateName(formData.city)) {
          showError('city', 'cityError', 'City name should contain only letters');
          isValid = false;
        } else {
          clearError('city', 'cityError');
        }

        // State validation
        if (!formData.state || formData.state.trim().length < 2) {
          showError('state', 'stateError', 'Please enter a valid state name');
          isValid = false;
        } else if (!validateName(formData.state)) {
          showError('state', 'stateError', 'State name should contain only letters');
          isValid = false;
        } else {
          clearError('state', 'stateError');
        }

        // PIN code validation
        if (!formData.pinCode || !validatePinCode(formData.pinCode)) {
          showError('pinCode', 'pinCodeError', 'Please enter a valid 6-digit PIN code');
          isValid = false;
        } else {
          clearError('pinCode', 'pinCodeError');
        }

        // Country validation
        if (!formData.country) {
          showError('country', 'countryError', 'Please select a country');
          isValid = false;
        } else {
          clearError('country', 'countryError');
        }

        return isValid;
      }

      // Handle form submission
      document.getElementById('userInfoForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formDataObj = new FormData(this);
        const data = Object.fromEntries(formDataObj);

        // Validate form
        if (!validateForm(data)) {
          return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');

        try {
          const formData = new FormData();
          
          formData.append('mobileNumber', data.mobileNumber || '');
          formData.append('emergencyContactNumber', data.emergencyContactNumber || '');
          
          if (data.birthDate && data.birthDate.trim()) {
            formData.append('birthDate', data.birthDate.trim());
          } else {
            throw new Error('Please select a birth date');
          }
          
          formData.append('city', data.city || '');
          formData.append('gender', data.gender || '');
          formData.append('streetAddress', data.streetAddress || '');
          formData.append('state', data.state || '');
          formData.append('pinCode', data.pinCode || '');
          formData.append('country', data.country || '');
          formData.append('bloodGroup', data.bloodGroup || '');
          formData.append('medicalConditions', data.medicalConditions || '');
          formData.append('allergies', data.allergies || '');

          console.log('Form Data Being Sent:');
          for (let [key, value] of formData.entries()) {
            console.log(`${key}: "${value}"`);
          }

          const response = await fetch('/api/updateUser/', {
            method: 'PUT',
            credentials: 'include',
            body: formData
          });

          if (!response.ok) {
            let errorMessage = 'Failed to save user information';
            try {
              const rawResponse = await response.text();
              const errorData = JSON.parse(rawResponse);
              
              if (errorData.detail) {
                if (Array.isArray(errorData.detail)) {
                  const errors = errorData.detail.map(err => {
                    const field = err.loc ? err.loc.join('.') : 'unknown';
                    return `${field}: ${err.msg}`;
                  }).join(', ');
                  errorMessage = errors;
                } else {
                  errorMessage = errorData.detail;
                }
              }
            } catch (e) {
              console.error('Could not parse error response:', e);
            }
            throw new Error(errorMessage);
          }
          
          const result = await response.json();
          console.log('Form submission successful:', result);
          showSuccessMessage('User information saved successfully!');

          setTimeout(() => {
            window.location.href = '/';
          }, 1500);

        } catch (error) {
          console.error('Error saving user information:', error);
          showSuccessMessage(error.message);
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
          submitBtn.classList.remove('loading');
        }
      });

      // Reset form
      function resetForm() {
        if (confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
          document.getElementById('userInfoForm').reset();
          
          document.getElementById('fname').value = userData.fname;
          document.getElementById('lname').value = userData.lname;
          document.getElementById('email').value = userData.email;
          
          // Clear all errors
          const errorFields = ['mobileNumber', 'emergencyContactNumber', 'gender', 'bloodGroup', 
                               'birthDate', 'streetAddress', 'city', 'state', 'pinCode', 'country'];
          errorFields.forEach(field => {
            const errorId = field + 'Error';
            if (field === 'gender') {
              clearError('male', errorId);
            } else {
              clearError(field, errorId);
            }
          });
        }
      }

      // Logout function
      function logout() {
        if (confirm('Are you sure you want to logout?')) {
          fetch('/api/logout', {
            method: 'GET',
            credentials: 'include'
          }).then(response => {
            if (response.ok) {
              window.location.href = '/';
            } else {
              console.error('Logout failed:', response);
            }
          });
        }
      }

      // Clear errors on input
      ['mobileNumber', 'emergencyContactNumber', 'bloodGroup', 'birthDate', 
       'streetAddress', 'city', 'state', 'pinCode', 'country'].forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (input) {
          input.addEventListener('input', () => {
            const errorId = fieldId + 'Error';
            clearError(fieldId, errorId);
          });
        }
      });

      // Gender radio buttons
      document.querySelectorAll('input[name="gender"]').forEach(radio => {
        radio.addEventListener('change', () => {
          clearError('male', 'genderError');
        });
      });

      // Mobile number formatting
      document.getElementById('mobileNumber').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
      });

      document.getElementById('emergencyContactNumber').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
      });

      // PIN code formatting
      document.getElementById('pinCode').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
      });

      // Set max date for birth date
      document.getElementById('birthDate').setAttribute('max', new Date().toISOString().split('T')[0]);

      // Canvas Animation (same as login page)
      function n(e) {
        this.init(e || {});
      }
      n.prototype = {
        init: function (e) {
          this.phase = e.phase || 0;
          this.offset = e.offset || 0;
          this.frequency = e.frequency || 0.001;
          this.amplitude = e.amplitude || 1;
        },
        update: function () {
          return (
            (this.phase += this.frequency),
            (window.canvasE = this.offset + Math.sin(this.phase) * this.amplitude)
          );
        },
        value: function () {
          return window.canvasE;
        },
      };

      function Line(e) {
        this.init(e || {});
      }

      Line.prototype = {
        init: function (e) {
          this.spring = e.spring + 0.1 * Math.random() - 0.05;
          this.friction = window.E.friction + 0.01 * Math.random() - 0.005;
          this.nodes = [];
          for (var t, n = 0; n < window.E.size; n++) {
            t = new Node();
            t.x = window.pos.x;
            t.y = window.pos.y;
            this.nodes.push(t);
          }
        },
        update: function () {
          let e = this.spring,
            t = this.nodes[0];
          t.vx += (window.pos.x - t.x) * e;
          t.vy += (window.pos.y - t.y) * e;
          for (var n, i = 0, a = this.nodes.length; i < a; i++)
            (t = this.nodes[i]),
              0 < i &&
                ((n = this.nodes[i - 1]),
                (t.vx += (n.x - t.x) * e),
                (t.vy += (n.y - t.y) * e),
                (t.vx += n.vx * window.E.dampening),
                (t.vy += n.vy * window.E.dampening)),
              (t.vx *= this.friction),
              (t.vy *= this.friction),
              (t.x += t.vx),
              (t.y += t.vy),
              (e *= window.E.tension);
        },
        draw: function () {
          let e,
            t,
            n = this.nodes[0].x,
            i = this.nodes[0].y;
          window.ctx.beginPath();
          window.ctx.moveTo(n, i);
          for (var a = 1, o = this.nodes.length - 2; a < o; a++) {
            e = this.nodes[a];
            t = this.nodes[a + 1];
            n = 0.5 * (e.x + t.x);
            i = 0.5 * (e.y + t.y);
            window.ctx.quadraticCurveTo(e.x, e.y, n, i);
          }
          e = this.nodes[a];
          t = this.nodes[a + 1];
          window.ctx.quadraticCurveTo(e.x, e.y, t.x, t.y);
          window.ctx.stroke();
          window.ctx.closePath();
        },
      };

      function onMousemove(e) {
        function o() {
          window.lines = [];
          for (let e = 0; e < window.E.trails; e++)
            window.lines.push(
              new Line({ spring: 0.45 + (e / window.E.trails) * 0.025 })
            );
        }
        function c(e) {
          e.touches
            ? ((window.pos.x = e.touches[0].pageX),
              (window.pos.y = e.touches[0].pageY))
            : ((window.pos.x = e.clientX), (window.pos.y = e.clientY)),
            e.preventDefault();
        }
        function l(e) {
          1 == e.touches.length &&
            ((window.pos.x = e.touches[0].pageX),
            (window.pos.y = e.touches[0].pageY));
        }
        document.removeEventListener("mousemove", onMousemove),
          document.removeEventListener("touchstart", onMousemove),
          document.addEventListener("mousemove", c),
          document.addEventListener("touchmove", c),
          document.addEventListener("touchstart", l),
          c(e),
          o(),
          render();
      }

      function render() {
        if (window.ctx.running) {
          window.ctx.globalCompositeOperation = "source-over";
          window.ctx.clearRect(
            0,
            0,
            window.ctx.canvas.width,
            window.ctx.canvas.height
          );
          window.ctx.globalCompositeOperation = "lighter";
          window.ctx.strokeStyle =
            "hsla(" + Math.round(window.f.update()) + ",100%,50%,0.025)";
          window.ctx.lineWidth = 10;
          for (var e, t = 0; t < window.E.trails; t++) {
            (e = window.lines[t]).update();
            e.draw();
          }
          window.ctx.frame++;
          window.requestAnimationFrame(render);
        }
      }

      function resizeCanvas() {
        window.ctx.canvas.width = window.innerWidth;
        window.ctx.canvas.height = window.innerHeight;
      }

      window.canvasE = 0;
      window.pos = {};
      window.lines = [];
      window.E = {
        debug: true,
        friction: 0.5,
        trails: 80,
        size: 50,
        dampening: 0.025,
        tension: 0.99,
      };

      function Node() {
        this.x = 0;
        this.y = 0;
        this.vy = 0;
        this.vx = 0;
      }

      function renderCanvas() {
        window.ctx = document.getElementById("canvas").getContext("2d");
        if (!window.ctx) return;
        window.ctx.running = true;
        window.ctx.frame = 1;
        window.f = new n({
          phase: Math.random() * 2 * Math.PI,
          amplitude: 85,
          frequency: 0.0015,
          offset: 285,
        });
        document.addEventListener("mousemove", onMousemove);
        document.addEventListener("touchstart", onMousemove);
        document.body.addEventListener("orientationchange", resizeCanvas);
        window.addEventListener("resize", resizeCanvas);
        window.addEventListener("focus", () => {
          if (!window.ctx.running) {
            window.ctx.running = true;
            render();
          }
        });
        window.addEventListener("blur", () => {
          window.ctx.running = true;
        });
        resizeCanvas();
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadUserData();
        renderCanvas();
        
        // Auto-resize textareas
        document.querySelectorAll('textarea').forEach(textarea => {
          textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
          });
        });
      });
    </script>
  </body>
</html>